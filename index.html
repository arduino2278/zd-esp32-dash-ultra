<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ultrason ESP32</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f0f0f0;
    padding: 30px;
  }

  h1 {
    color: #333;
  }

  #distance {
    font-size: 2em;
    margin: 20px 0;
  }

  /* LED rouge réaliste */
  .led {
    width: 60px;
    height: 60px;
    margin: 20px auto;
    border-radius: 50%;
    background: #550000; /* éteinte */
    box-shadow: 0 0 10px #000;
    transition: background 0.3s, box-shadow 0.3s;
  }

  .led.on {
    background: #ff0000;
    box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222;
    animation: glow 1s infinite alternate;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 10px #ff4444, 0 0 20px #ff2222; }
    50% { box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222; }
    100% { box-shadow: 0 0 25px #ff7777, 0 0 35px #ff3333; }
  }

  /* Graphique */
  #chartContainer {
    width: 90%;
    max-width: 800px;
    margin: 40px auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<h1>Dashboard Ultrason ESP32</h1>
<div id="distance">Distance : -- cm</div>
<div class="led" id="ledRed"></div>

<div id="chartContainer">
  <canvas id="distanceChart"></canvas>
</div>

<script>
  // ----- CONFIGURATION -----
  const BLYNK_TOKEN = '-7-xZBmu_CuhFF5pM1VZAHSUr_bg6oJh';
  const PIN_DISTANCE = 'V6';
  const UPDATE_INTERVAL = 1000; // ms
  const MAX_POINTS = 60; // points à afficher sur le graphique

  const distanceElem = document.getElementById('distance');
  const ledElem = document.getElementById('ledRed');

  // ----- HISTORIQUE DES DONNÉES -----
  let distanceData = [];
  let labels = [];

  // ----- INIT GRAPH -----
  const ctx = document.getElementById('distanceChart').getContext('2d');
  const distanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Distance (cm)',
        data: distanceData,
        borderColor: 'red',
        backgroundColor: 'rgba(255,0,0,0.2)',
        tension: 0.3,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          suggestedMin: 0,
          suggestedMax: 50
        }
      },
      plugins: {
        legend: {
          display: true
        }
      }
    }
  });

  // ----- FONCTION DE MISE À JOUR -----
  async function updateData() {
    try {
      const response = await fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&pin=${PIN_DISTANCE}`);
      const data = await response.text();
      const distance = parseFloat(data);

      // ---- AFFICHAGE ----
      distanceElem.textContent = `Distance : ${distance.toFixed(1)} cm`;

      // ---- LED rouge ----
      if(distance < 10) {
        ledElem.classList.add('on');
      } else {
        ledElem.classList.remove('on');
      }

      // ---- MISE À JOUR DU GRAPHIQUE ----
      if(distanceData.length >= MAX_POINTS) {
        distanceData.shift();
        labels.shift();
      }
      distanceData.push(distance);
      labels.push(new Date().toLocaleTimeString());

      distanceChart.update();
    } catch(err) {
      console.error('Erreur Blynk API:', err);
    }
  }

  // ----- BOUCLE -----
  setInterval(updateData, UPDATE_INTERVAL);
  updateData();
</script>

</body>
</html>
