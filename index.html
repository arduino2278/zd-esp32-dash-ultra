<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ultrason ESP32</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f0f0f0;
    padding: 30px;
  }

  h1 {
    color: #333;
  }

  /* Jauge */
  #gaugeContainer {
    width: 200px;
    height: 200px;
    margin: 20px auto;
    position: relative;
  }

  #gaugeBackground {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #ddd;
    position: absolute;
    top: 0;
    left: 0;
  }

  #gaugeFill {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    clip-path: circle(50% at 50% 50%);
    background: green;
    transform: rotate(-90deg);
    transform-origin: center;
    position: absolute;
    top: 0;
    left: 0;
    transition: background 0.5s, transform 0.5s;
  }

  /* LED rouge réaliste */
  .led {
    width: 60px;
    height: 60px;
    margin: 20px auto;
    border-radius: 50%;
    background: #550000; /* éteinte */
    box-shadow: 0 0 10px #000;
    transition: background 0.3s, box-shadow 0.3s;
  }

  .led.on {
    background: #ff0000;
    box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222;
    animation: glow 1s infinite alternate;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 10px #ff4444, 0 0 20px #ff2222; }
    50% { box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222; }
    100% { box-shadow: 0 0 25px #ff7777, 0 0 35px #ff3333; }
  }

  /* Graphique */
  #chartContainer {
    width: 90%;
    max-width: 800px;
    margin: 40px auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<h1>Dashboard Ultrason ESP32</h1>

<!-- Jauge distance -->
<div id="gaugeContainer">
  <div id="gaugeBackground"></div>
  <div id="gaugeFill"></div>
</div>

<!-- LED rouge -->
<div class="led" id="ledRed"></div>

<!-- Graphique historique -->
<div id="chartContainer">
  <canvas id="distanceChart"></canvas>
</div>

<script>
  // ----- CONFIGURATION -----
  const BLYNK_TOKEN = '-7-xZBmu_CuhFF5pM1VZAHSUr_bg6oJh';
  const PIN_DISTANCE = 'V6';
  const UPDATE_INTERVAL = 1000; // ms
  const MAX_POINTS = 60;

  const ledElem = document.getElementById('ledRed');
  const gaugeFill = document.getElementById('gaugeFill');

  // ----- HISTORIQUE GRAPHIQUE -----
  let distanceData = [];
  let labels = [];

  const ctx = document.getElementById('distanceChart').getContext('2d');
  const distanceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Distance (cm)',
        data: distanceData,
        borderColor: 'red',
        backgroundColor: 'rgba(255,0,0,0.2)',
        tension: 0.3,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { suggestedMin: 0, suggestedMax: 50 }
      }
    }
  });

  // ----- MISE À JOUR JAUSTRIQUE -----
  function updateGauge(distance) {
    // rotation jauge (0 cm = 100% rempli, max 50 cm = 0%)
    let rotation = Math.min(distance, 50) / 50 * 180; // 0-180 degrés
    gaugeFill.style.transform = `rotate(${rotation - 90}deg)`; // ajustement -90

    // Couleur dynamique
    let color;
    if(distance < 10) {
      // rouge foncé quand proche
      let intensity = Math.floor(255 - distance * 15); // distance 0->10 : 255->105
      color = `rgb(${intensity},0,0)`;
    } else {
      // vert clair quand loin
      let intensity = Math.min(255, 100 + (distance-10)*10); // 10->50 : 100->440 (max 255)
      intensity = Math.min(intensity, 255);
      color = `rgb(0,${intensity},0)`;
    }
    gaugeFill.style.background = color;
  }

  // ----- MISE À JOUR DONNÉES -----
  async function updateData() {
    try {
      const response = await fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&pin=${PIN_DISTANCE}`);
      const data = await response.text();
      const distance = parseFloat(data);

      // LED rouge animation
      if(distance < 10) {
        ledElem.classList.add('on');
      } else {
        ledElem.classList.remove('on');
      }

      // jauge
      updateGauge(distance);

      // graphique historique
      if(distanceData.length >= MAX_POINTS) {
        distanceData.shift();
        labels.shift();
      }
      distanceData.push(distance);
      labels.push(new Date().toLocaleTimeString());
      distanceChart.update();

    } catch(err) {
      console.error('Erreur Blynk API:', err);
    }
  }

  setInterval(updateData, UPDATE_INTERVAL);
  updateData();

</script>

</body>
</html>
