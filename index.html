<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ultrason ESP32</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f0f0f0;
    padding: 30px;
  }

  h1 {
    color: #333;
  }

  #distance {
    font-size: 2em;
    margin: 20px 0;
  }

  /* LED rouge réaliste */
  .led {
    width: 60px;
    height: 60px;
    margin: 20px auto;
    border-radius: 50%;
    background: #550000; /* éteinte */
    box-shadow: 0 0 10px #000;
    transition: background 0.3s, box-shadow 0.3s;
  }

  .led.on {
    background: #ff0000;
    box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222;
    animation: glow 1s infinite alternate;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 10px #ff4444, 0 0 20px #ff2222; }
    50% { box-shadow: 0 0 20px #ff5555, 0 0 30px #ff2222; }
    100% { box-shadow: 0 0 25px #ff7777, 0 0 35px #ff3333; }
  }

  /* Graphiques */
  #chartContainer, #gaugeContainer {
    width: 90%;
    max-width: 800px;
    margin: 40px auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }

  #gaugeContainer {
    height: 200px;
  }
</style>
</head>
<body>

<h1>Dashboard Ultrason ESP32</h1>
<div id="distance">Distance : -- cm</div>

<!-- LED rouge -->
<div class="led" id="ledRed"></div>

<!-- Jauge -->
<div id="gaugeContainer">
  <canvas id="distanceGauge"></canvas>
</div>

<!-- Graphique historique -->
<div id="chartContainer">
  <canvas id="distanceChart"></canvas>
</div>

<script>
  // ----- CONFIGURATION -----
  const BLYNK_TOKEN = '1gJPTklt2nr0UAlJg4Srvzhp4DaHMmJE';
  const PIN_JAUGE = 'V0';
  const PIN_LED = 'V1';
  const UPDATE_INTERVAL = 1000; // ms
  const MAX_POINTS = 60; // points à afficher sur le graphique

  const distanceElem = document.getElementById('distance');
  const ledElem = document.getElementById('ledRed');

  // ----- HISTORIQUE DES DONNÉES -----
  let distanceData = [];
  let labels = [];

  // ----- INIT GRAPH LINE -----
  const ctxLine = document.getElementById('distanceChart').getContext('2d');
  const distanceChart = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Distance (cm)',
        data: distanceData,
        borderColor: 'red',
        backgroundColor: 'rgba(255,0,0,0.2)',
        tension: 0.3,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          suggestedMin: 0,
          suggestedMax: 50
        }
      },
      plugins: {
        legend: { display: true }
      }
    }
  });

  // ----- INIT GAUGE -----
  const ctxGauge = document.getElementById('distanceGauge').getContext('2d');
  const distanceGauge = new Chart(ctxGauge, {
    type: 'doughnut',
    data: {
      labels: ['Distance', 'Rest'],
      datasets: [{
        data: [0, 50], // initial
        backgroundColor: ['red', '#eee'],
        borderWidth: 0
      }]
    },
    options: {
      rotation: -90,
      circumference: 180,
      cutout: '70%',
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });

  // ----- FONCTION DE MISE À JOUR -----
  async function updateData() {
    try {
      // ---- Jauge ----
      const resGauge = await fetch(`https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&pin=${PIN_JAUGE}`);
      const dataGauge = await resGauge.text();
      const distance = parseFloat(dataGauge);

      // ---- AFFICHAGE DISTANCE ----
      distanceElem.textContent = `Distance : ${distance.toFixed(1)} cm`;

      // ---- LED rouge ----
      if(distance < 10) {
        ledElem.classList.add('on');
      } else {
        ledElem.classList.remove('on');
      }

      // ---- MISE À JOUR DU GRAPHIQUE LINE ----
      if(distanceData.length >= MAX_POINTS) {
        distanceData.shift();
        labels.shift();
      }
      distanceData.push(distance);
      labels.push(new Date().toLocaleTimeString());
      distanceChart.update();

      // ---- MISE À JOUR DE LA GAUGE ----
      distanceGauge.data.datasets[0].data[0] = distance;
      distanceGauge.data.datasets[0].data[1] = 50 - distance; // max 50 cm
      distanceGauge.update();

    } catch(err) {
      console.error('Erreur Blynk API:', err);
    }
  }

  // ----- BOUCLE -----
  setInterval(updateData, UPDATE_INTERVAL);
  updateData();
</script>

</body>
</html>
